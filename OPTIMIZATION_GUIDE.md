# 🎾 网球场预约监控插件 - 监控准确性优化说明

## 🎯 本次优化内容

### 1. **智能容器选择**
- 按优先级排序选择器，优先检测具体的预约相关容器
- 避免检测过于通用的容器导致误报
- 增加了 `[data-time]`、`[data-slot]` 等高精度选择器

### 2. **更严格的内容验证**
- **时间信息检测**: 必须包含 `HH:MM` 格式的时间
- **场地信息检测**: 增强场地关键词匹配（如"1号场"、"网球馆"）
- **日期信息检测**: 识别日期相关信息
- **价格信息检测**: 检测价格信息提高置信度
- **文本清洁度**: 避免包含HTML标签的脏数据

### 3. **智能置信度评分**
- **基础分数**: 20分（降低了基础分）
- **优先级权重**: 高优先级选择器额外加分
- **时间信息**: +30分（最重要）
- **场地信息**: +25分
- **日期信息**: +15分
- **价格信息**: +10分
- **文本长度**: 根据长度合理性加减分
- **最低阈值**: 提高到70%（之前是60%）

### 4. **更精确的排除逻辑**
- **近距离检测**: 如果"已选择"等排除词与"可预约"距离很近，认为是同一上下文
- **精确匹配**: 避免误报已选择状态的时段

### 5. **重复内容去重**
- **相似度算法**: 使用编辑距离计算文本相似度
- **智能去重**: 80%以上相似度认为重复
- **文本标准化**: 避免同一时段的不同表示被重复计算

### 6. **智能重试机制**
- **页面加载检测**: 检查 `document.readyState`
- **多次重试**: 最多3次重试，递增等待时间
- **错误恢复**: 自动处理脚本执行失败的情况

### 7. **增强调试信息**
- **详细日志**: 每个步骤都有详细的控制台输出
- **置信度分析**: 显示每个检测到的时段的置信度
- **调试统计**: 页面文本长度、关键词出现次数等

## 🧪 测试方法

### 1. **使用测试页面**
打开 `monitor-test.html`，这个页面包含：
- 真实的网球场预约表格
- 多种状态：可预约、已预约、已选择、不可预约
- 动态测试控制：添加/移除可预约时段
- 实时调试信息显示

### 2. **监控流程**
1. 在Chrome中加载扩展
2. 打开测试页面
3. 启动监控功能
4. 观察控制台输出和通知

### 3. **预期效果**
- **高准确性**: 只通知真正的可预约时段
- **低误报率**: 不会将"已选择"等状态误报为可预约
- **详细信息**: 通知中包含具体时间、场地和置信度信息
- **智能重试**: 页面加载不完整时自动重试

## 🔍 调试技巧

### 1. **查看控制台**
按F12打开开发者工具，查看Console标签：
- 搜索 `🔍` 查看检测过程
- 搜索 `✨` 查看发现的可预约时段
- 搜索 `📊` 查看统计信息

### 2. **高亮显示**
检测到的可预约时段会被高亮显示：
- 黄色背景 + 红色边框
- 方便直观查看检测结果

### 3. **通知内容**
通知会显示：
- 具体时间段（如"08:00-09:00"）
- 场地信息（如"1号场"）
- 置信度统计
- 页面调试信息

## ⚡ 性能优化

### 1. **选择器优化**
- 避免过于宽泛的选择器
- 优先使用精确的选择器
- 减少不必要的DOM查询

### 2. **处理去重**
- 使用Set避免重复处理相同容器
- 智能相似度计算避免重复通知

### 3. **内存管理**
- 限制HTML输出长度
- 及时清理无用变量
- 合理的重试次数限制

## 🔧 故障排除

### 1. **无法检测到可预约时段**
- 检查页面是否完全加载
- 查看控制台是否有错误
- 尝试手动刷新页面

### 2. **误报问题**
- 查看置信度分数是否合理
- 检查排除关键词是否生效
- 调整置信度阈值（如有需要）

### 3. **重复通知**
- 确认去重逻辑是否正常
- 检查相似度计算是否准确

## 📈 未来改进

1. **机器学习**: 基于用户反馈训练模型
2. **自适应阈值**: 根据页面特征动态调整置信度阈值
3. **更多页面支持**: 适配不同的预约系统界面
4. **用户自定义**: 允许用户自定义关键词和规则

---

通过这些优化，监控准确性应该有显著提升。如果仍有问题，请查看控制台日志获取更多调试信息。
